<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Compétences & Attendus — P4</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <h1>Compétences & Attendus — P4</h1>
    <p class="subtitle">Vue transversale : Math · Français · Histoire · Géographie</p>
  </header>

  <div class="searchbar">
    <input id="q" type="search" placeholder="Rechercher (domaine, matière, compétence, attendu…)" />
    <button id="export">Exporter CSV</button>
    <button id="reset">Réinitialiser</button>
    <a href="index.html" class="button-link">← Retour au programme</a>
  </div>

  <!-- Filtres (mêmes styles que l'accueil) -->
  <div class="filters">
    <label>
      Semaine
      <select id="f-week">
        <option value="">Toutes</option>
      </select>
    </label>
    <label>
      Domaine
      <select id="f-domain">
        <option value="">Tous</option>
      </select>
    </label>
  </div>

  <!-- Tableau -->
  <section class="table-wrap">
    <table id="grid">
      <thead>
        <tr>
          <th style="width:80px">Semaine</th>
          <th style="width:200px">Domaine</th>
          <th style="width:220px">Matière / Thème</th>
          <th>Objectif</th>
          <th>Compétence</th>
          <th>Attendu</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" class="empty" style="display:none">Aucun résultat avec ces filtres.</div>
  </section>

  <footer>
    <small>© Programme P4 — Compétences & Attendus</small>
  </footer>

  <script>
    const DATA_URL = './data/competences_attendus.json';
    const $q = document.getElementById('q');
    const $week = document.getElementById('f-week');
    const $domain = document.getElementById('f-domain');
    const $tbody = document.querySelector('#grid tbody');
    const $empty = document.getElementById('empty');
    const $export = document.getElementById('export');
    const $reset = document.getElementById('reset');

    let ROWS = [];
    let COLUMNS = ["Semaine","Domaine","Matiere","Objectifs","Competence","Attendu"];

    async function load(){
      const res = await fetch(DATA_URL);
      const json = await res.json();
      // format {columns, rows}
      COLUMNS = json.columns || COLUMNS;
      ROWS = json.rows || [];
      hydrateFilters(ROWS);
      render();
      bind();
    }

    function hydrateFilters(data){
      // semaines
      const weeks = Array.from(new Set(data.map(r => r.Semaine).filter(Boolean))).sort((a,b)=>{
        const na = parseInt(String(a).replace(/\D/g,''))||0;
        const nb = parseInt(String(b).replace(/\D/g,''))||0;
        return na - nb;
      });
      weeks.forEach(w=>{
        const opt = document.createElement('option');
        opt.value = w; opt.textContent = w;
        $week.appendChild(opt);
      });
      // domaines
      const domains = Array.from(new Set(data.map(r => r.Domaine).filter(Boolean))).sort();
      domains.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d;
        $domain.appendChild(opt);
      });
    }

    function bind(){
      [$q, $week, $domain].forEach(el => el.addEventListener('input', render));
      $reset.addEventListener('click', ()=>{
        $q.value = ''; $week.value = ''; $domain.value = '';
        render();
      });
      $export.addEventListener('click', exportCSV);
    }

    function filterRows(){
      const q = $q.value.trim().toLowerCase();
      const wf = $week.value;
      const df = $domain.value;
      return ROWS.filter(r=>{
        if(wf && String(r.Semaine) !== String(wf)) return false;
        if(df && r.Domaine !== df) return false;
        if(!q) return true;
        const hay = [
          r.Semaine||'', r.Domaine||'', r.Matiere||r.Theme||'',
          r.Objectifs||'', r.Competence||'', r.Attendu||''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    function render(){
      const rows = filterRows();
      $tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(r.Semaine)}</td>
          <td>${esc(r.Domaine)}</td>
          <td>${esc(r.Matiere || r.Theme)}</td>
          <td>${esc(r.Objectifs)}</td>
          <td>${esc(r.Competence)}</td>
          <td>${esc(r.Attendu)}</td>
        `;
        $tbody.appendChild(tr);
      });
      $empty.style.display = rows.length ? 'none' : 'block';
    }

    function exportCSV(){
      const rows = filterRows();
      const cols = COLUMNS;
      let csv = cols.join(';') + '\n';
      rows.forEach(r=>{
        csv += cols.map(k => String((r[k] ?? '')).replaceAll(';', ',').replaceAll('\n',' ')).join(';') + '\n';
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'competences_attendus.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function esc(v){ return (v==null?'':String(v)).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
