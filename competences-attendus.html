<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programmes P4 ‚Äî Comp√©tences & Attendus</title>
<link rel="stylesheet" href="./styles.css">
<meta name="theme-color" content="#2563eb">
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Comp√©tences & Attendus ‚Äî P4</h1>
      <div class="searchbar">
        <input id="q" type="search" placeholder="Rechercher (domaine, mati√®re, comp√©tence, attendu)‚Ä¶">
        <select id="week" aria-label="Filtrer par semaine">
          <option value="all">Toutes</option>
        </select>
        <button id="export" title="Exporter la vue actuelle en CSV">Exporter CSV</button>
      </div>
      <button type="button"
        onclick="location.href='index.html'"
        aria-label="Revenir √† l‚Äôaccueil">
        ‚Üê Retour au programme
      </button>
    </header>

    <!-- (pas d‚Äôonglets ici, mais m√™me card/table que l‚Äôaccueil) -->
    <div class="card">
      <table class="table">
        <thead id="headers"></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <p class="footer">Astuce : ajoute cette page √† l‚Äô√©cran d‚Äôaccueil pour l‚Äôavoir hors-ligne. Imprime proprement via Ctrl/Cmd+P.</p>
  </div>

  <script>
    // --- Configuration ---
    const DATA_URL = './data/competences_attendus.json';
    // colonnes rendues √† l‚Äô√©cran (ordre coh√©rent avec tes usages)
    const DISPLAY_COLS = ["Semaine","Domaine","Matiere","Objectifs","Competence","Attendu"];

    // --- √âl√©ments DOM ---
    const $q = document.getElementById('q');
    const $week = document.getElementById('week');
    const $thead = document.getElementById('headers');
    const $tbody = document.getElementById('rows');
    const $export = document.getElementById('export');

    // --- √âtat ---
    let COLUMNS = [];
    let ROWS = [];
    let FILTERED = [];

    // --- Utilitaires ---
    const esc = s => (s==null ? '' : String(s)).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const numWeek = w => parseInt(String(w||'').replace(/\D/g,'')) || 0;

    function stripComments(txt){
      // permet de lire un JSON qui contiendrait des commentaires /* ... */ ou // ...
      return txt.replace(/\/\*[\s\S]*?\*\//g, '').replace(/(^|\s)\/\/.*$/gm, '');
    }

    async function load(){
      const res = await fetch(DATA_URL, {cache:'no-store'});
      const raw = await res.text();
      const json = JSON.parse(stripComments(raw));
      COLUMNS = Array.isArray(json.columns) && json.columns.length ? json.columns : DISPLAY_COLS;
      ROWS = Array.isArray(json.rows) ? json.rows : [];
      hydrateHeader();
      hydrateWeeks();
      bind();
      render();
    }

    function hydrateHeader(){
      // ent√™tes visuelles = DISPLAY_COLS pour coh√©rence
      $thead.innerHTML = `<tr>${DISPLAY_COLS.map(c=>`<th>${esc(c)}</th>`).join('')}</tr>`;
    }

    function hydrateWeeks(){
      // remplir la liste des semaines pr√©sentes (S1‚Ä¶S34)
      const set = new Set(ROWS.map(r => r.Semaine).filter(Boolean));
      const list = Array.from(set).sort((a,b)=>numWeek(a)-numWeek(b));
      for(const w of list){
        const opt = document.createElement('option');
        opt.value = w; opt.textContent = w;
        $week.appendChild(opt);
      }
    }

    function filterRows(){
      const q = $q.value.trim().toLowerCase();
      const w = $week.value;
      const term = (r) => [
        r.Semaine||'',
        r.Domaine||'',
        r.Matiere || r.Theme || '',
        r.Objectifs||'',
        r.Competence||'',
        r.Attendu||''
      ].join(' ').toLowerCase();

      return ROWS
        .filter(r => w==='all' || String(r.Semaine)===String(w))
        .filter(r => !q || term(r).includes(q));
    }

    function render(){
      FILTERED = filterRows();
      $tbody.innerHTML = FILTERED.map(r => `
        <tr>
          <td>${esc(r.Semaine)}</td>
          <td>${esc(r.Domaine)}</td>
          <td>${esc(r.Matiere || r.Theme)}</td>
          <td>${esc(r.Objectifs)}</td>
          <td>${esc(r.Competence)}</td>
          <td>${esc(r.Attendu)}</td>
        </tr>
      `).join('') || `
        <tr><td colspan="${DISPLAY_COLS.length}" style="opacity:.7">Aucun r√©sultat avec ces crit√®res.</td></tr>
      `;
    }

    function exportCSV(){
      const cols = DISPLAY_COLS;
      let csv = cols.join(';') + '\n';
      FILTERED.forEach(r=>{
        csv += cols.map(k => String((r[k] ?? (k==='Matiere' ? r['Theme'] ?? '' : ''))).replaceAll(';', ',').replaceAll('\n',' ')).join(';') + '\n';
      });
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'competences_attendus.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function bind(){
      [$q, $week].forEach(el => el.addEventListener('input', render));
      $export.addEventListener('click', exportCSV);
    }

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>
