<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Générateur de fiches</title>

  <!-- Belle police -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Outils export PNG / PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 24px;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 4px 18px rgba(15, 23, 42, 0.12);
      margin-bottom: 16px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
      display: block;
    }

    select,
    textarea,
    input[type="text"],
    input[type="number"] {
      width: 100%;
      font-family: inherit;
      font-size: 0.9rem;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    select:focus,
    textarea:focus,
    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .field {
      flex: 1 1 220px;
      min-width: 180px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }

    .btn-primary {
      background: #4f46e5;
      color: white;
      box-shadow: 0 3px 12px rgba(79, 70, 229, 0.35);
    }

    .btn-secondary {
      background: white;
      color: #111827;
      border: 1px solid #d1d5db;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .preview-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-start;
    }

    .preview-label {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* La fiche elle-même */
    #fiche {
      position: relative;
      width: 17cm;         /* largeur fixe 17 cm */
      padding: 12mm;       /* marges internes */
      background: #ffffff;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 18px rgba(15, 23, 42, 0.10);
      overflow: hidden;
    }

    /* Pastille Domaine / Champ / Numéro */
    .badge {
      position: absolute;
      top: 8px;
      right: 8px;
      max-width: 60%;
      background: rgba(79, 70, 229, 0.06);
      border: 1px solid rgba(79, 70, 229, 0.3);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #312e81;
      text-align: right;
      line-height: 1.2;
      white-space: normal;
    }

    .badge span.domain {
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .badge-bottom .field {
      font-weight: 500;
      color: #4b5563;
      flex: 1;
      text-align: left;
    }

    .badge-bottom .numero {
      font-weight: 600;
      color: #111827;
      white-space: nowrap;
    }

    /* Titre de la fiche */
    .fiche-title {
      margin-top: 30px;
      font-size: 1.15rem;
      font-weight: 600;
      text-decoration: underline;
      color: #111827;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .fiche-content {
      margin-top: 0;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #111827;
      white-space: pre-wrap;
    }

    .no-fiche {
      font-size: 0.85rem;
      color: #9ca3af;
      font-style: italic;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      #fiche {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>Générateur de fiches (17 cm de large)</h1>

      <div class="form-row">
        <div class="field">
          <label for="domaine">Domaine</label>
          <select id="domaine">
            <option value="Mathématiques">Mathématiques</option>
            <option value="Français">Français</option>
            <option value="Éveil">Éveil</option>
          </select>
        </div>

        <div class="field">
          <label for="champ">Champ</label>
          <select id="champ"></select>
        </div>

        <div class="field" style="max-width: 120px;">
          <label for="numero">Numéro</label>
          <input type="number" id="numero" min="1" step="1" placeholder="1" />
        </div>
      </div>

      <div class="form-row">
        <div class="field" style="flex: 1 1 100%">
          <label for="titre">Titre de la fiche</label>
          <input type="text" id="titre" placeholder="Ex : Les polygones, Le passé composé, Les volcans…" />
        </div>
      </div>

      <div class="form-row">
        <div class="field" style="flex: 1 1 100%">
          <label for="texte">Texte de la fiche</label>
          <textarea id="texte" placeholder="Écris ici le contenu de la fiche…"></textarea>
        </div>
      </div>

      <div class="buttons">
        <button class="btn btn-primary" id="btnGenerer">Générer la fiche</button>
        <button class="btn btn-secondary" id="btnPng" disabled>Télécharger en PNG</button>
        <button class="btn btn-secondary" id="btnPdf" disabled>Télécharger en PDF</button>
      </div>
    </div>

    <div class="panel">
      <div class="preview-wrapper">
        <div class="preview-label">Prévisualisation :</div>
        <div id="preview-area">
          <p class="no-fiche">Aucune fiche générée pour l’instant.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Préparation jsPDF
    window.jsPDF = window.jspdf.jsPDF;

    // Domaines et champs possibles
    const domainConfig = {
      "Mathématiques": [
        "Arithmétique à l’Algèbre",
        "Espace et Géométrie",
        "Grandeurs et relations",
        "Organisation des données et statistique"
      ],
      "Français": [
        "Grammaire",
        "Conjugaison",
        "Outil de la langue"
      ],
      "Éveil": [
        "Sciences",
        "Histoire",
        "Géographie"
      ]
    };

    const domaineSelect = document.getElementById("domaine");
    const champSelect   = document.getElementById("champ");
    const numeroInput   = document.getElementById("numero");
    const titreInput    = document.getElementById("titre");
    const texteArea     = document.getElementById("texte");
    const btnGenerer    = document.getElementById("btnGenerer");
    const btnPng        = document.getElementById("btnPng");
    const btnPdf        = document.getElementById("btnPdf");
    const previewArea   = document.getElementById("preview-area");

    // Met à jour la liste des champs selon le domaine
    function refreshChampOptions() {
      const domaine = domaineSelect.value;
      const champs = domainConfig[domaine] || [];
      champSelect.innerHTML = "";
      champs.forEach(ch => {
        const opt = document.createElement("option");
        opt.value = ch;
        opt.textContent = ch;
        champSelect.appendChild(opt);
      });
    }

    // Construction propre du nom de fichier
    function buildFileName() {
      const domaine = (domaineSelect.value || "").trim();
      const champ   = (champSelect.value || "").trim();
      const titre   = (titreInput.value || "").trim();

      // Base : titre si présent, sinon Domaine - Champ, sinon "fiche"
      let base = titre || [domaine, champ].filter(Boolean).join(" - ") || "fiche";

      // Ajoute "fiche - " au début si pas déjà là (peu importe la casse)
      if (!/^fiche\b/i.test(base)) {
        base = "fiche - " + base;
      }

      // Supprime les accents (optionnel mais propre pour les fichiers)
      base = base.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

      // Remplace les caractères interdits sur les systèmes de fichiers
      // (\ / : * ? " < > |) par un espace
      base = base.replace(/[\\\/:*?"<>|]/g, " ");

      // Réduit les espaces multiples, trim début/fin
      base = base.replace(/\s+/g, " ").trim();

      // Si tout a été mangé pour une raison X → fallback
      if (!base) base = "fiche";

      return base;
    }

    // Crée la fiche dans la prévisualisation
    function generateFiche() {
      const domaine = domaineSelect.value;
      const champ   = champSelect.value;
      const numero  = numeroInput.value.trim();
      const titre   = titreInput.value.trim();
      const texte   = texteArea.value.trim();

      if (!texte) {
        alert("Écris d’abord le texte de la fiche.");
        return;
      }

      // Nettoyer la zone de prévisualisation
      previewArea.innerHTML = "";

      // Créer la fiche
      const fiche = document.createElement("div");
      fiche.id = "fiche";

      // Pastille domaine/champ/numéro
      const badge = document.createElement("div");
      badge.className = "badge";

      const spanDomain = document.createElement("span");
      spanDomain.className = "domain";
      spanDomain.textContent = domaine;

      const bottom = document.createElement("div");
      bottom.className = "badge-bottom";

      const fieldSpan = document.createElement("span");
      fieldSpan.className = "field";
      fieldSpan.textContent = champ;

      bottom.appendChild(fieldSpan);

      if (numero) {
        const numeroSpan = document.createElement("span");
        numeroSpan.className = "numero";
        numeroSpan.textContent = "n° " + numero;
        bottom.appendChild(numeroSpan);
      }

      badge.appendChild(spanDomain);
      badge.appendChild(bottom);
      fiche.appendChild(badge);

      // Titre (si renseigné)
      if (titre) {
        const h = document.createElement("div");
        h.className = "fiche-title";
        h.textContent = titre;
        fiche.appendChild(h);
      } else {
        // Petit espace si pas de titre
        const spacer = document.createElement("div");
        spacer.style.height = "20px";
        fiche.appendChild(spacer);
      }

      // Contenu principal
      const content = document.createElement("div");
      content.className = "fiche-content";
      content.textContent = texte;

      fiche.appendChild(content);
      previewArea.appendChild(fiche);

      // Activer les boutons d’export
      btnPng.disabled = false;
      btnPdf.disabled = false;
    }

    // Export PNG
    async function exportPNG() {
      const fiche = document.getElementById("fiche");
      if (!fiche) return;

      const canvas = await html2canvas(fiche, {
        scale: 3,
        useCORS: true
      });
      const dataURL = canvas.toDataURL("image/png");

      const link = document.createElement("a");
      const fileBase = buildFileName();   // <-- nom propre
      link.download = fileBase + ".png";
      link.href = dataURL;
      link.click();
    }

    // Export PDF (fiche centrée sur A4)
    async function exportPDF() {
      const fiche = document.getElementById("fiche");
      if (!fiche) return;

      const canvas = await html2canvas(fiche, {
        scale: 3,
        useCORS: true
      });
      const imgData = canvas.toDataURL("image/png");

      const pdf = new jsPDF("p", "mm", "a4");
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      // Largeur voulue : 170 mm = 17 cm
      const ficheWidthMm = 170;
      const ratio = canvas.height / canvas.width;
      const ficheHeightMm = ficheWidthMm * ratio;

      const x = (pageWidth - ficheWidthMm) / 2;
      const y = (pageHeight - ficheHeightMm) / 2;

      pdf.addImage(imgData, "PNG", x, y, ficheWidthMm, ficheHeightMm);

      const fileBase = buildFileName();   // <-- nom propre
      pdf.save(fileBase + ".pdf");
    }

    // Listeners
    domaineSelect.addEventListener("change", refreshChampOptions);
    btnGenerer.addEventListener("click", generateFiche);
    btnPng.addEventListener("click", exportPNG);
    btnPdf.addEventListener("click", exportPDF);

    // Initialisation
    refreshChampOptions();
  </script>
</body>
</html>
